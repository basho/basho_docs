---
title: CAP コントロールを調整する
project: riak
version: 0.10.0+
document: tutorial
audience: beginner
keywords: [tutorial, fast-track]
prev: "[[リンクとリンクウォーキング]]"
up:   "[[The Riak Fast Track]]"
versions: false
interest: [
"[[Installing and Upgrading]]",
"[[Concepts]]",
"[[Querying Riak]]",
"[[System Planning]]",
"[[Basic Cluster Setup]]",
"[[Use Cases]]"
]
---

さて、長い道のりでした。Fast Track にきちんと従っていれば、Riak の概要、ローカルマシンに3ノードのクラスタ1つ、HTTP インタフェースでの簡単な作業、そしてちょっとした MapReduce クエリの実行を行ったはずです。

Fast Track の最後のセクションは、Riak がどのようにしてデータをクラスタ全体に分散させるか、さらに整合性とアベイラビリティのレベルを調整する方法について説明しましょう。これは大きな価値と、アプリケーションへの影響を与えます。そしてこれが、Riak を他と区別する重要な機能の1つです。

ページの末尾には、あなたのアプリケーションおよびビジネスに適合するようにレプリカのレベルを調整する方法を簡単に説明する、最後のスクリーンキャストがあります。とにかく、それをご覧いただく前に以下を軽くお読みください。

## N、R、W についての手引き

Riak は開発者に対して、データのコピーをいくつ作るかをバケットのレベルまで調整する方法を提供しています。これには N、R、W 値を使用します。

Riak のデザインは Dr. Eric Brewer の CAP 定理に基づきます。CAP 定理は分散システムを3つのプロパティで定義します。整合性(Consistency)、アベイラビリティ(Availability)、分断化(エラー)耐性(Partition)です。一度に使用できるのは3つのプロパティのうち2つだけであるというのが定理の内容です。

Riak は CAP のうち、A と P に着目しています。これにより Riak はいつかは整合性が取れる(結果整合性)ということになります。といっても、"結果整合性" に要する時間はミリセカンドであり、これはほとんどのアプリケーションに取って十分な時間だと言えます。

### N 値とレプリケーション

Riak に格納されているすべてのデータは、バケットに設定されているプロパティ N 値(n_val)によって、クラスタ内で複数のノードにレプリケーションされます。デフォルトでは n_val は "3" となっています。バケットに格納されたデータは3つの異なるノードにレプリケーションされる、すなわち3つのコピーが格納されるということです。これが有効に働くためには、最低3つの物理ノードがクラスタになければいけません(このメリットについてローカルノードで御覧いただけます)。

バケットの N 値を変更する(デフォルトと違う値にする)ためには、PUT リクエストで新しい N 値をバケットに伝えます。Riak で3つのノードが動いているならば、このようにしてください:

```bash
$ curl -v -XPUT -H "Content-Type: application/json" -d '{"props":{"n_val":2}}' \
  http://127.0.0.1:8091/riak/another_bucket
```

これでバケット "another_bucket" の n_val が 2 に変更されました。つまりデータはクラスタ内の2つのパーティションにレプリケーションされるということです。

<div class="note"><div class="title">A Word on Setting the N Value</div>レプリケーションの利点を享受するためには、n_val は 0 より大きく、クラスタの大きさ以下でなければなりません。また、作成したばかりのバケットの n_val を修正することはお勧めしません。新しい値がすべてのパーティションに適切にレプリケーションされないかもしれません。</div>

### R 値と読み出しエラー耐性

先程のコマンドで、バケットの n_val を 2 に変更しました。

Riak ではフェッチごとに "R 値" を設定することができます。R 値というのは、読み出しが成功したとみなされるために、読み出し結果を返さなければいけない Riak ノードの数を示します。これによってノードがダウンしていたり、のろのろしていても、読み出しアベイラビリティが保証されます。

たとえば、この HTTP リクエストでは r 値を 1 にしています。

```bash
http://127.0.0.1:8091/riak/images/1.png?r=1
```

これによってクラスタに最低1つのコピーがあれば、Riak はコピーを返します。

### W 値と書き込みエラー耐性

Riak では、更新ごとに "W 値" を設定することができます。W 値というのは、書き込みが完了したとみなされるために、成功を返さなければならない Riak ノードの数を示します。これによってノードがダウンしていたり、のろのろしていても、書き込みアベイラビリティが保証されます。

この PUT オペレーションでは、w 値を 3 にセットしています。

```bash
$ curl -v -XPUT http://127.0.0.1:8091/riak/docs/story.txt?w=3 \
  -H "Content-type: text/plain" --data-binary @story.txt
```

### 整合性シンボル

Riak 0.12 では便利で分かりやすくするために R および W の整合性オプションにシンボルを用意しました。

* *all* - すべてのレプリカがリプライを返さねばならない。これは R および W を N と同じ値にするのと等価である。
* *one* - R および W を 1 に設定する。
* *quorum* - レプリカの過半数が応答しなければならない、すなわち 1/2 + 1。N 値がデフォルトの 3 のときは 2 となる。
* *default* - バケットごとの整合性プロパティ R または W が上記のシンボルや整数のいくつであっても、デフォルトを使う。Uses whatever the per-bucket consistency property is for R or W, which may be any of the above values, or an integer.

R または W の値を指定しないときは、"default" を送ったのと同じです。

## N、R、W の動き

ノード3つの Riak クラスタで、N、R、W 値がどのように働くかを簡単に紹介するスクリーンキャストです:

<div style="display:none" class="iframe-video" id="http://player.vimeo.com/video/11172656"></div>

<p><a href="http://vimeo.com/11172656">Tuning CAP Controls in Riak</a> from <a href="http://vimeo.com/bashotech">Basho Technologies</a> on <a href="http://vimeo.com">Vimeo</a>.</p>

### この次は？

お疲れ様でした。これをお読みになり、Fast Track を試されていたら、ノード3つの Riak クラスタができているはずで、その中にはスクリプトによっていくつかのデータがあり、基本的な API の実行、MapReduce でのクエリ、CAP コントロールの能力についての紹介を行いました。いうまでもありませんが、ほんとうにご苦労様でした。

でも、Riak の学習はこれで終わりではありません。Riak について興味がおありでしたら、次のステップに進むためのリストをご紹介します。もしもお時間があれば、_mark@basho.com_ 宛てに、ご感想、ご要望、そして Riak Fast Track をより良くするためのご提案をお寄せください。

* Riak についての一般的な情報がご入用でしたら [[出版物|Publications]] と [[スライド|Slide Decks]] を参照してください。
* さまざまな言語から Riak を操作する方法については、[[クライアントライブラリ|Client Libraries]] をご覧ください。
* プラットフォームごとの Riak パッケージをダウンロードするには、[[はじめましょう|Installation]] をご覧ください。
* Riak が他のデータベースよりも優れている点をお知りになりたければ [[Riak 比較表|Riak Comparisons]] を参照してください。
* Riak のソースがご入用でしたら [[GitHub|http://github.com/basho/riak]] にあります。


末尾になりましたが、このチュートリアルの作成、およびアップデートと修正にご協力いただいた皆様に大きな[[感謝|Thank You]]を捧げます。
